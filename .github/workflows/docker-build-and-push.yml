name: "Build and push Docker image"

# Trigger on commits to main, on pushed tags (releases), and manually.
on:
  push:
    branches:
      - main
    tags:
      - '*'

  workflow_dispatch:

# Grant least privileges needed by this workflow:
# - read repository contents
# - push image packages to ghcr.io
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      # Node image tag used by Dockerfile base image.
      # https://hub.docker.com/_/node/
      NODE_IMAGE_TAG: 22-alpine

    steps:
      # 1) Check out source code used for docker build context.
      - name: Check out repository
        uses: actions/checkout@v6

      # 2) Create a Buildx builder. Buildx uses BuildKit under the hood.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3) Authenticate to GitHub Container Registry.
      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4) Intentionally pull the latest Node base image tag on the runner.
      # This is kept for explicitness and visibility in workflow logs.
      - name: Pull latest Node.js image
        run: docker pull node:${{ env.NODE_IMAGE_TAG }}

      # 5) Compute Docker tags and OCI labels from GitHub event metadata.
      - name: Pull metadata from GitHub
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}

      # 6) Build and push image using BuildKit/Buildx.
      # `pull: true` ensures base layers are refreshed by the builder itself,
      # which is the key setting for avoiding stale base images in buildx builds.
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          pull: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NODE_IMAGE_TAG=${{ env.NODE_IMAGE_TAG }}
